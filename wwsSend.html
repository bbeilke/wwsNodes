<script type="text/javascript">
    RED.nodes.registerType('wwsSend',{
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: {value:""},
            wwsApplications: {value:"",type:"wwsApplications"},
            allSpaces: {value:false},
            listSpaces: {value:""},
            spaceId: {value:""},
            update: {value:""}
        },
        inputs:1,
        outputs:0,
        icon: "wws.png",
        label: function() {
            return this.name||"WWS Send";
        }, 
        oneditprepare: function() {
        	console.log("Oneditprepare");
        	var nodeConfig = this;
        	console.log(nodeConfig.wwsApplications);
        	console.log(nodeConfig.accessToken);
        	if (typeof(wwsApp) != "undefined") {
        			console.log(wwsApp);
        			console.log(wwsApp.listSpaces);
        			nodeConfig.listSpaces = wwsApp.listSpaces;
        	};
        	function enable_spacelist() {
        		if ($("#node-input-allSpaces").is(':checked')) {
            		$("#node-spaceId").hide();            		
    	        	if (typeof(wwsApp) != "undefined") {
    					$("node-input-listSpaces").val(wwsApp.listSpaces);
    					nodeConfig.listSpaces = wwsApp.listSpaces;
    	        	};
            		$("#node-listId").show();
            		nodeConfig.allSpaces = true;
        		} else {
    	        	if (typeof(wwsApp) != "undefined") {
    					nodeConfig.listSpaces = wwsApp.listSpaces;
    					show_spaces();
    	        	}
            		$('#node-spaceId').show();
            		$("#node-listId").hide();
            		nodeConfig.allSpaces = false;
        		};
        	};
        	
       		$("#node-input-allSpaces").on("click", function () {
        		$("#node-input-update").val(Date.now);
        		enable_spacelist();
       		});
			enable_spacelist();
			
			$("#node-input-listSpaces").load(function () {
	        	if (typeof(wwsApp) != "undefined") {
	        		console.log("node-input-listSpaces is visible");
					$("node-input-listSpaces").val(wwsApp.listSpaces);
	        	};
			});
			
			
			function show_spaces(){
				console.log("ShowSpaces");
				var listSpaces=nodeConfig.listSpaces;
				$("#node-input-listSpaces").val(listSpaces);
				console.log(listSpaces);
				var option='';
				if (listSpaces=="No space found yet") {
					option='<option value="">No space found yet</option>';
				} else { 
					var objListSpaces = JSON.parse(listSpaces);
					for(var i = 0; i < objListSpaces.length; i++) {
					    var space = objListSpaces[i];
				    	if (space.id == nodeConfig.spaceId) {
				    	option += '<option value="'+ space.id + '" selected>' + space.title + '</option>';
				    	} else {
						option += '<option value="'+ space.id + '">' + space.title + '</option>';				    	
				    	}
				    	console.log(nodeConfig.spaceId);
				    	console.log(space.id);
				    	console.log(space.title);
					}
				};
				$('#node-input-spaceId').empty().append(option);
			};
			show_spaces();
    	}
    });
</script>

<script type="text/x-red" data-template-name="wwsSend">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-wwsApplications"><i class="icon-tag"></i> WWS App</label>
        <input type="text" id="node-input-wwsApplications" placeholder="Waston Work App">
    </div>
    <div class="form-row" id="node-allSpaces">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-allSpaces" style="display: inline-block; width: auto; vertical-align: top;" checked>
        <label for="node-input-allSpaces" style="width: 70%;"> Send to all spaces</label>
    </div>
    <div class="form-row" id="node-spaceId">
        <label for="node-input-spaceId"><i class="fa fa-empire"></i><span> SpaceID</span></label>
        <select id="node-input-spaceId" style="width:300px !important">
<!--
			<option value="580e30c3e4b0e0daf7d77b87">FDSpace</option>
			<option value="580f725de4b0279617b9fe8b">TestAPI</option> 
-->

		</select>
    </div>
    <div class="form-row" id="node-listId">
        <label for="node-input-listSpaces"><i class="fa fa-list"></i> Spaces</label>
        <input type="text" id="node-input-listSpaces" placeholder="" readonly>
    </div>    

	<div class="form-row" style="display:none !important">
        <label for="node-input-update"><i class="fa fa-list"></i> Timestamp</label>
        <input type="text" id="node-input-update" placeholder="">
    </div>


</script>

<script type="text/x-red" data-help-name="wwsSend">
    <p>A node to send a massage IBM Watson Work Services</p>
</script>